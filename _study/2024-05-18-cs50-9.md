---
title: "[CS50] 09 SQL"
date: 2024-05-18
permalink: /study/2024-05-18-cs50-9
categories: basic
tags:
  - SQL
---

In this post, the ninth lecture of CS50 is summarized.

# Flat-file database
Flat-file database is code for a text file containing your data. Your data has delimiters that separate some values from others. The most common approach is to use comma-separated values, or, CSV files.
## CSV 
In simple text alone, newline characters like '\n' are used to distinguish rows and ',' is used to distinguish columns. In Google Sheets, Excel, and Numbers, you can export your data not in proprietary Apple, Microsoft or Google format, but in a globally portable format known as .csv.
In python, you can import csv library which is a python module that gives you csv related functionality.
```python
import csv

file = open("favorites.csv", "r")
# Do something with file
close(file)
```
To work with csv files, you can use above code but more pythonic way is to write code as below.
```python
import csv

with open("favorites.csv", "r") as file:
    reader = csv.reader(file)
    next(reader) # to get start from the second line of csv file since the first is header
    for row in reader:
        print(row[1])
```
If you use, keyword 'with', the file willbe automatically closed. The CSV reader in python is going to return to you, one row after another through the loop. 'row[1]' refers to the second column data in that row.
In the code above, the problems is that we have to remember the second column of each row is the data we care about - for instance, scores. But suppose someone can change the order of columns in csv file. Thus this code is fragile because I'm hopping that row[1] is always the data that I care about. Instead, we use the header row, and use Dictionary Reader instead of reader.

```python
import csv

with open("favorites.csv", "r") as file:
    reader = csv.DictReader(file)
    for row in reader:
        print(row["language"])
```
What DictReader does, which reader does not, is it automatically analyzes the first line in the file, figures out what are all of your columns called, and thereafter, when you iterate over this reader what each of your rows now is - it's no longer a list - a dictionary. Keys of whhich are from the header field. Now, let's do more things related to numbers.
```python
import csv
with open("favorites.csv", "r") as file:
    reader = csv.DictReader(file)
    scratch, c, python = 0, 0, 0

    for row in reader:
        favorite = row["language"]
        if favorite == "Scratch":
            scratch += 1
        elif favorite == "C:
            c += 1
        elif favorite == "Python":
            python += 1

print(f"scratch: {scratch}")
print(f"C: {c}")
print(f"python: {python}")
```
Below is more pythonic code using dictionary. The difference is I'm now using one dictionary instead of 3 variables.
```python
import csv

with open("favorites.csv", "r") as file:
    reader = csv.DictReader(file)
    counts = {}

    for row in reader:
        favorite = row["language"]
        if favorite in counts:
            counts[favorite] += 1
        else:
            countes[favorite] = 1

for favorite in sorted(counts, key=counts.get, reverse=True):
    printf(f"{favorite}: {countes[favorite]}")
```
sorted function sorts the dictionary by key by defalut. A dictionary is an object, so it has its own methods and one of them is get. And if you tell the sorted function to use thath built-in method, it will get its value from every key and sort effectively by the value.
Below is easier code to do the samething by using Counter object.
```python
import csv
from collections import Counter

with open("favorites.csv", "r") as file:
    reader = csv.DictReader(file)
    counts = Counter()

    for row in reader:
        favorite = row["language"]
        counts[favorite] += 1

for favorite, count in counts.most_common():
    printf(f"{favorite}: {count}")
```
What the Counter class is going to do is automatically initialize everything to 0. Also, Counter has method named most_common and it returns a pair of (key, value), (key, value).


# Relational Database
Instead of just dealing with CSV files, pure text, it turns out there's an entire world of proper databases. Not flat file databases where you store everything in text files, but a database program, a piece of software running on a computer, running on a server, that's always listening for you. It's got a lot of memory, it's got a lot of space, and in turn a lot of data, and it supports a database specific language that makes it much easier, much faster to ask questions of the very same data. It's a relational database in the sense that it's not even necessarily one spreadsheet, you can have many sheets across which there might very well be relationships or relations.

## SQL
SQL - Structured Query Language - is a database specific language. It's a declarative language whereby you're not going to be in the habit with SQL of writing loops and conditionals but instead you're going to describe the data that you want to get back, you're going to describe the question that you want the answer to.
### CRUD paradigm
SQL follows CRUD paradigm. In relational database, you can really only do 4 things. You can CREATE, READ, UPDATE, DELETE the data. Specifically in SQL, there's going to be other keywords that map to those 4 ideas. Technically you don't just create data in the world of SQL, you can also insert it. And people use SELECT instead of READ. DROP lets you destructively, very dangerously delete entire database tables.

![CRUD](..\images\2024-05-18-cs50-9\CRUD.jpg)

## SQLite
SQLite is an implementation of SQL. SQLite is really popular on Macs, PCs, and phones nowadays. A lot of the data that games and other applications on your phone might store a binary file that's in the SQLite format.
### CREATE new DB
```console
$ sqlite3 favorites.db
Are you sure you want to create favorites.db? [y/N] y
sqlite>
```
### load CSV file
```console
sqlite> .mode csv
sqlite> .import favorites.csv favorites
sqlite> .quit
$ ls favorites.csv favorites.db
favorites.csv favorites.db
```
.mode csv puts SQLite into CSV mode.

```console
sqlite> .schema
CREATE TABLE IF NOT EXISTS "favorites"(
"Timestamp" TEXT, "language" TEXT, "problem" TEXT);
```
.schema is a command that show me the schema of this database table. This is showimg me, the SQL command that was automatically run when I imported this database the first time around.
### SELECT data
```console
SELECT column FROM table;
```
```consolje
sqlite> SELECT * FROM favorites;
sqlite> SELECT languagte FROM favorites;
sqlite> SELECT languagte FROM favorites LIMIT 10;

```
There are bunch of keywords like these built into SQL. Below is the code to count the number of rows in table.
```console
sqlite> SELECT COUNT(*) FROM favorites;
sqlite> SELECT COUNT(language) FROM favorites;
```
```console
sqlite> SELECT DISTINCT(language) FROM favorites;
sqlite> SELECT COUNT(DISTINCT(language)) FROM favorites;
```
```console
sqlite> SELECT COUNT(*) FROM favorites WHERE language = 'C';
sqlite> SELECT COUNT(*) FROM favorites WHERE language = 'C' AND problem = 'Hello, World';
```
```console
sqlite> SELECT language, COUNT(*) FROM favorites GROUP BY language;
sqlite> SELECT language, COUNT(*) FROM favorites GROUP BY language ORDER BY COUNT(*);
sqlite> SELECT language, COUNT(*) FROM favorites GROUP BY language ORDER BY COUNT(*) DESC;
sqlite> SELECT language, COUNT(*) AS n FROM favorites GROUP BY language ORDER BY n DESC;
sqlite> SELECT language, COUNT(*) AS n FROM favorites GROUP BY language ORDER BY n DESC LIMIT 1;
```
### INSERT data
```console
INSERT INTO table (column, ...) VALUES(value, ...)
```
```console
sqlite> INSERT INTO favorites (language, problem) VALUES('SQL', 'Fiftyville');
```
In the world of SQL, NULL has nothing to do with pointers or addresses, it's just using the same word to represent the same idea, that there's no data here.
### DELETE data
```console
DELETE FROM table WHERE condition;
```
```console
DELETE FROM favorites;
```
The code above may be the most destructive things you can do as a database administator. If you google around, there are horror stories of interns in the real world executing commands like this at their companies. This will delte everything from favorites. 
```console
sqlite> DELETE FROM favorites WHERE Timestamp IS NULL;
```
### UPDATE data
```console
UPDATE table SET column = value WHERE condition;
```
```
sqlite> UPDATE favorites SET language = 'SQL', problem = 'Fiftyville'
```
